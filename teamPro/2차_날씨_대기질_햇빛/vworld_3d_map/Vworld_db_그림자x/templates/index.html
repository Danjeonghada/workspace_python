<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>VWorld ì•„íŒŒíŠ¸ ê²€ìƒ‰ + ì¼ì¡°ëŸ‰ ë¶„ì„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- VWorld ì§€ë„ API -->
    <script src="https://map.vworld.kr/js/webglMapInit.js.do?version=3.0&apiKey=59E8E97C-1463-372A-9540-000DB836F45D&domain=localhost"></script>
    <!-- ì¼ì¡°ëŸ‰ ë¶„ì„ API -->
    <script src="https://map.vworld.kr/js/dtkmap/tool3d/libapis/sunlight/sunlight_analysis_api.min.js"></script>
    <!-- jQuery + UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        #vmap { width: 100%; height: 350px; }
        .search-bar {
          padding: 10px;
          background: #f5f5f5;
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          align-items: center;
        }
        select, input { padding: 5px; font-size: 14px; }
    </style>
</head>
<body>

<div id="vmap"></div>

<!-- ê²€ìƒ‰ UI -->
<div class="search-bar">
    <input type="text" id="aptName" placeholder="ì•„íŒŒíŠ¸ëª… ì…ë ¥" style="width: 200px;">
    <select id="aptBlock">
        <option value="">ë™ ì„ íƒ</option>
    </select>
    <button onclick="search()">ê²€ìƒ‰</button>
</div>

<!-- ì¼ì¡°ëŸ‰ ë¶„ì„ UI -->
<div class="search-bar" style="background:#e8e8e8">
    <button id="btnPoint">ğŸ“ ì§€ì  ì„ íƒ</button>
    <label>ë¶„ì„ ë‚ ì§œ:
        <input type="text" id="anaDate"/>
    </label>
    <label>ì‹œê°„ë³„ íƒœì–‘ìœ„ì¹˜:
        <span id="time_span" style="display:inline-block;width:30px;">09</span>:00
        <input type="range" id="anaTim" min="4" max="20" step="1"/>
    </label>
    <label>ì‹œê°„ë²”ìœ„:
        <select id="anaStTime"></select> ~ <select id="anaEdTime"></select>
    </label>
    <label>ê°„ê²©:
        <select id="anlysTimeInterval">
            <option value="15">15ë¶„</option>
            <option value="10">10ë¶„</option>
            <option value="5">5ë¶„</option>
            <option value="1">1ë¶„</option>
        </select>
    </label>
    <button id="runAnlys">â˜€ ë¶„ì„ ìˆ˜í–‰</button>
</div>

<script>
    let map;

    function vwmapInit() {
      const options = {
        mapId: "vmap",
        initPosition: new vw.CameraPosition(
          new vw.CoordZ(127.3845, 36.3504, 2000),
          new vw.Direction(0, -60, 0)
        ),
        logo: true, navigation: true
      };
      map = new vw.Map();
      map.setOption(options);
      map.start();
    }

    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById("anaDate").value = `${yyyy}-${mm}-${dd}`;
    }

    function fillTimeOptions() {
      const stSel = document.getElementById("anaStTime");
      const edSel = document.getElementById("anaEdTime");
      for (let i = 4; i <= 20; i++) {
        const txt = `${i.toString().padStart(2, '0')}ì‹œ`;
        stSel.insertAdjacentHTML('beforeend', `<option value="${i}">${txt}</option>`);
        edSel.insertAdjacentHTML('beforeend', `<option value="${i}">${txt}</option>`);
      }
      stSel.value = "9";
      edSel.value = "18";
    }

    // ë°˜ë“œì‹œ í•œ ë²ˆë§Œ ë“±ë¡
    document.addEventListener("DOMContentLoaded", () => {
      vwmapInit();
      setTodayDate();
      fillTimeOptions();

      setTimeout(() => {
        sunlightAnalysis.createSunObject();
      }, 400);

      // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
      document.getElementById("anaTim").addEventListener("input", function () {
        const val = this.value;
        document.getElementById("time_span").innerText = val.toString().padStart(2, '0');
        sunlightAnalysis.createSunObject();
      });

      // ì§€ì  ì„ íƒ
      document.getElementById("btnPoint").addEventListener("click", () => {
        sunlightAnalysis.drawPointOnMap();
      });

      // ë¶„ì„ ìˆ˜í–‰
      document.getElementById("runAnlys").addEventListener("click", () => {
        const date = document.getElementById("anaDate").value;
        const interval = parseInt(document.getElementById("anlysTimeInterval").value);
        const stTime = parseInt(document.getElementById("anaStTime").value) + 1;
        const edTime = parseInt(document.getElementById("anaEdTime").value);

        if (!date) return alert("ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        sunlightAnalysis.runSunlight(interval, stTime, edTime, function(ResultInfo) {
          console.log("âœ… ë¶„ì„ ì™„ë£Œ", ResultInfo);
          alert("âœ” ì¼ì¡°ëŸ‰ ë¶„ì„ ì™„ë£Œ (ì½˜ì†” í™•ì¸)");
        });
      });
    });

    // ì•„íŒŒíŠ¸ëª… ìë™ì™„ì„± ë“±ì€ ê·¸ëŒ€ë¡œ
    $(function() {
      $("#aptName").autocomplete({
        source: function(req, res) {
          $.ajax({ url: "/autocomplete_name", type: "GET", data: { term: req.term }, success: res });
        },
        select: function(_, ui) {
          $("#aptName").val(ui.item.value);
          loadBlockOptions(ui.item.value);
          return false;
        }
      });
    });

    function loadBlockOptions(aptName) {
      $.ajax({
        url: "/get_blocks",
        type: "GET",
        data: { apt_name: aptName },
        success: function(data) {
          const $block = $("#aptBlock");
          $block.empty();
          $block.append('<option value="">ë™ ì„ íƒ</option>');
          const sorted = data.sort((a, b) => parseInt(a.replace(/\D/g, '')) - parseInt(b.replace(/\D/g, '')));
          sorted.forEach(block => $block.append(`<option value="${block}">${block}</option>`));
        }
      });
    }

    function search() {
      map.clear();
      const aptName = $("#aptName").val().trim();
      const aptBlock = $("#aptBlock").val();
      if (!aptName || !aptBlock) return alert("ì•„íŒŒíŠ¸ëª…ê³¼ ë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      $.ajax({
        url: "/search_address",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ name: aptName, block: aptBlock }),
        success: function(res) {
          if (res.success) {
            const lat = res.latitude, lng = res.longitude;
            const pos = new vw.CoordZ(lng, lat, 500);
            map.moveTo(new vw.CameraPosition(pos, new vw.Direction(0, -90, 0)));

            const pt = new vw.geom.Point(new vw.Coord(lng, lat));
            pt.setImage("https://map.vworld.kr/images/op02/map_point.png");
            pt.setName(res.apartment_name);
            pt.setFont("ê³ ë”•");
            pt.setFontSize(14);
            pt.create();

            pt.addEventListener((pos, _, __, f) => {
              if (f) {
                const html = `<b>${res.apartment_name}</b><br>ìœ„ë„: ${lat}<br>ê²½ë„: ${lng}<br>ë°©í–¥: ${res.direction}<br>ë™ ì´ë¦„: ${res.dong_name}`;
                new vw.Popup("popup", "vmap", res.apartment_name, html, 200, 120, pos.x, pos.y).create();
              }
            });
          } else {
            alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + res.message);
          }
        },
        error: () => alert("ì„œë²„ ì˜¤ë¥˜")
      });
    }
</script>

</body>
</html>
