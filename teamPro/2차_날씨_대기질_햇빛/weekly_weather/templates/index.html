<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>ì•„íŒŒíŠ¸ ì¼ì‚¬ëŸ‰ ë¶„ì„</title>
    <style>
        .autocomplete-list { border: 1px solid #ccc; max-height: 160px; overflow-y: auto; }
        .autocomplete-item { padding: 5px; cursor: pointer; }
        .autocomplete-item:hover { background: #e0e0ff; }
        #resultArea img { margin-top: 20px; }
        pre { font-family: 'Malgun Gothic', 'monospace'; }
        .weather-table {
            border-collapse: collapse;
            margin: 8px 0 14px 0;
            width: 100%;
            max-width: 850px;
            min-width: 340px;
            font-size: 0.97em;
        }
        .weather-table th, .weather-table td {
            padding: 5px 8px;
        }
        .weather-table th {
            background: #e9f3ff; color: #003262;
        }
        .weather-table tr:nth-child(even) {
            background: #fafdff;
        }
        .weather-table .sunny { color: #f7b90d; font-weight: bold; }
        .weather-table .cloud { color: #4a7db8; font-weight: bold; }
        .weather-table .rain { color: #3285ff; font-weight: bold; }
        .weather-table .snow { color: #85bcff; font-weight: bold; }
        .weather-table .hazy { color: #999; }
        /* ë“±ê¸‰ ì»¬ëŸ¬ */
        .weather-table .grade-excellent { color: #006edc; font-weight:bold; }
        .weather-table .grade-good { color: #23a931; font-weight:bold; }
        .weather-table .grade-normal { color: #ca8602; }
        .weather-table .grade-soso { color: #ab8c4b; }
        .weather-table .grade-bad { color: #c90000; font-weight:bold; }
        .weather-table .grade-worst { color: #910000; background:#ffdddd;font-weight:bold;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h3>ì•„íŒŒíŠ¸ëª… ê²€ìƒ‰</h3>
<input type="text" id="aptInput" autocomplete="off" placeholder="ì•„íŒŒíŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:250px;">
<div id="autocomplete" class="autocomplete-list"></div>
<div id="blockArea"></div>
<div style="width: 100%; max-width: 850px; margin: 20px 0;">
    <canvas id="solarChart"></canvas>
</div>
<div id="resultArea"></div>

<div id="weeklyWeatherArea"></div>

<div id="sampleWeeklyTable" style="margin-top:60px;"></div>

<script>
    const aptInput = document.getElementById('aptInput');
    const autocomplete = document.getElementById('autocomplete');
    const blockArea = document.getElementById('blockArea');
    const resultArea = document.getElementById('resultArea');
    let selectedAptCode = null;
    let solarChartObj = null;

    // ì•„íŒŒíŠ¸ ìë™ì™„ì„±
    aptInput.addEventListener('input', async function() {
        const val = this.value.trim();
        autocomplete.innerHTML = '';
        blockArea.innerHTML = '';
        resultArea.innerHTML = '';
        if (solarChartObj) solarChartObj.destroy();
        selectedAptCode = null;
        if (val.length < 1) return;
        const res = await fetch('/search_apartment?q=' + encodeURIComponent(val));
        const data = await res.json();
        autocomplete.innerHTML = '';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = item.name;
            div.onclick = () => selectApartment(item);
            autocomplete.appendChild(div);
        });
    });

    async function selectApartment(item) {
        aptInput.value = item.name;
        autocomplete.innerHTML = '';
        resultArea.innerHTML = '';
        if (solarChartObj) solarChartObj.destroy();
        selectedAptCode = item.code;
        const res = await fetch('/get_blocks?kapt_code=' + encodeURIComponent(selectedAptCode));
        const blocks = await res.json();
        if (blocks.length === 0) {
            blockArea.innerHTML = "<span>ë™/ë¸”ë¡ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</span>";
            return;
        }
        let html = '<h4>ë™(ë¸”ë¡) ì„ íƒ</h4><select id="blockSelect">';
        blocks.forEach(b => {
            html += `<option value="${b.block}" data-direction="${b.direction}" data-dong="${b.dong}">${b.block} / ${b.direction}</option>`;
        });
        html += '</select>';
        html += '<input type="number" id="floorInput" placeholder="ì¸µìˆ˜ ì…ë ¥" min="1" max="50" style="width:80px;">';
        html += '<button id="analyzeBtn">ì¼ì‚¬ëŸ‰ ë¶„ì„</button>';
        blockArea.innerHTML = html;
        document.getElementById('analyzeBtn').onclick = analyzeSolar;
    }

    // "ì¼ì‚¬ëŸ‰ ë¶„ì„" ë²„íŠ¼ í´ë¦­ ì‹œ Chart.jsë¡œ ê·¸ë¦¬ê¸°
    async function analyzeSolar() {
        const blockSelect = document.getElementById('blockSelect');
        const selectedOption = blockSelect.options[blockSelect.selectedIndex];
        const block = selectedOption.value;
        const direction = selectedOption.getAttribute('data-direction');
        const dong = selectedOption.getAttribute('data-dong');
        const floor = document.getElementById('floorInput').value;
        if (!floor || isNaN(floor) || floor < 1) {
            alert("ì¸µìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }
        resultArea.innerHTML = "<span>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>";
        if (solarChartObj) solarChartObj.destroy();
        const res = await fetch('/analyze_solar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                apt_code: selectedAptCode,
                block: block,
                floor: floor,
                direction: direction,
                dong: dong
            })
        });
        const result = await res.json();
        // Chart.jsë¡œ ë°ì´í„° ì‹œê°í™”
        const xs = result.message
            .split('\n')
            .filter(line => line && !line.startsWith('ì‹œê°„'))
            .map(line => line.split('\t')[0]);
        const baseSolar = result.message
            .split('\n')
            .filter(line => line && !line.startsWith('ì‹œê°„'))
            .map(line => Number(line.split('\t')[2])); // "ê¸°ë³¸ ì¼ì‚¬ëŸ‰" (3ë²ˆì§¸)
        const finalSolar = result.message
            .split('\n')
            .filter(line => line && !line.startsWith('ì‹œê°„'))
            .map(line => Number(line.split('\t')[4])); // "ìµœì¢… ë³´ì • ì¼ì‚¬ëŸ‰" (5ë²ˆì§¸)
        const dry = result.message
            .split('\n')
            .filter(line => line && !line.startsWith('ì‹œê°„'))
            .map(line => line.split('\t')[5]);

        const ctx = document.getElementById('solarChart').getContext('2d');
        solarChartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: xs,
                datasets: [
                    {
                        label: 'ê¸°ë³¸ ì¼ì‚¬ëŸ‰ (W/ã¡)',
                        data: baseSolar,
                        fill: false,
                        borderColor: '#aaa',
                        backgroundColor: '#aaa',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.2,
                        borderDash: [6, 4],
                    },
                    {
                        label: 'ìµœì¢… ë³´ì • ì¼ì‚¬ëŸ‰ (W/ã¡)',
                        data: finalSolar,
                        fill: false,
                        borderColor: '#0078FF',
                        backgroundColor: '#0078FF',
                        pointRadius: 7,
                        pointHoverRadius: 10,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            title: ctx => `${ctx[0].label}`,
                            label: ctx => {
                                let line = `${ctx.dataset.label}: ${ctx.parsed.y} W/ã¡`;
                                if (ctx.datasetIndex === 1) {
                                    line += ` (ê±´ì¡° ì í•©ë„: ${dry[ctx.dataIndex]})`;
                                }
                                return line;
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'ì¼ì‚¬ëŸ‰ (W/ã¡)' } }
                }
            }
        });

        // ê²°ê³¼ í‘œ, ë‚ ì”¨, ëŒ€ê¸°ì§ˆì€ ì•„ë˜ì— ê·¸ëŒ€ë¡œ!
        resultArea.innerHTML = `
            <h4>ì˜¤ëŠ˜ì˜ ë‚ ì”¨(ì˜ˆì¸¡ 6ì‹œê°„)</h4>
            ${renderWeatherTable(result.weather_message || 'ë‚ ì”¨ ì •ë³´ ì—†ìŒ')}
            <h4>ì˜¤ëŠ˜ì˜ ëŒ€ê¸°ì§ˆ</h4>
            <pre>${result.air_message || 'ëŒ€ê¸°ì§ˆ ì •ë³´ ì—†ìŒ'}</pre>
        `;

        const dongName = document.getElementById('blockSelect')
    .selectedOptions[0]
    .getAttribute('data-dong');
const weeklyWeatherArea = document.getElementById('weeklyWeatherArea');
weeklyWeatherArea.innerHTML = "<span>ë‹¨ê¸°ì˜ˆë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>";
const weatherRes = await fetch('/api/weekly_weather?dong=' + encodeURIComponent(dongName));
const weeklyData = await weatherRes.json();

function renderWeeklyTable(arr) {
    if (!arr || arr.length === 0) return "<span>ì˜ˆë³´ ë°ì´í„° ì—†ìŒ</span>";
    let html = '<table class="weather-table">';
    html += `<tr>
        <th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ê¸°ì˜¨(â„ƒ)</th><th>ìŠµë„(%)</th><th>í’ì†(m/s)</th>
        <th>í’í–¥</th><th>í•˜ëŠ˜</th><th>ê°•ìˆ˜</th><th>í™˜ê¸°ì¶”ì²œ</th><th>ì‚¬ìœ </th>
    </tr>`;
    arr.forEach(r => {
        html += `<tr>
            <td>${r["ë‚ ì§œ"]}</td>
            <td>${r["ì‹œê°„"]}</td>
            <td>${r["ê¸°ì˜¨(â„ƒ)"]}</td>
            <td>${r["ìŠµë„(%)"]}</td>
            <td>${r["í’ì†(m/s)"]}</td>
            <td>${r["í’í–¥"]}</td>
            <td>${weatherIcon(r["í•˜ëŠ˜"])}</td>
            <td>${weatherIcon(r["ê°•ìˆ˜"])}</td>
            <td class="grade grade-${getGradeClass(r["í™˜ê¸°ì¶”ì²œ"])}">${r["í™˜ê¸°ì¶”ì²œ"]}</td>
            <td>${r["í™˜ê¸°ì¶”ì²œì‚¬ìœ "]}</td>
        </tr>`;
    });
    html += "</table>";
    html += `<div style="font-size:0.92em;margin:8px 0 0 3px;color:#888;">
        <b>ë‹¨ê¸°ì˜ˆë³´</b>: 3ì‹œê°„ ê°„ê²©, ìµœëŒ€ 7ì¼ê°„ ì˜ˆë³´ (ê¸°ì˜¨Â·ìŠµë„Â·í’ì†Â·í™˜ê¸°ì¶”ì²œ)
    </div>`;
    return html;
}
weeklyWeatherArea.innerHTML = "<h4>3ì‹œê°„ ê°„ê²© ë‹¨ê¸°ì˜ˆë³´</h4>" + renderWeeklyTable(weeklyData.weather_all);

// ë¯¸ì„¸ë¨¼ì§€ ì˜ˆë³´ í‘œ ì¶”ê°€!
weeklyWeatherArea.innerHTML += "<h4>ë¯¸ì„¸ë¨¼ì§€ ì˜ˆë³´(í™˜ê²½ë¶€ API)</h4>" + renderDustForecastTable(weeklyData.dust_forecast);
    }

    // ë“±ê¸‰ë³„ ì»¬ëŸ¬ í´ë˜ìŠ¤
    function getGradeClass(text) {
        if(!text) return '';
        if(text.includes('ë§¤ìš° ì í•©')) return 'excellent';
        if(text.includes('ì í•©')) return 'good';
        if(text.includes('ë‹¤ì†Œ ì í•©')) return 'normal';
        if(text.includes('ë‹¤ì†Œ ë¶€ì í•©')) return 'soso';
        if(text.includes('ë¶€ì í•©')) return 'bad';
        if(text.includes('ë§¤ìš° ë¶€ì í•©')) return 'worst';
        return '';
    }

    // ë‚ ì”¨ ìƒíƒœ â†’ ì´ëª¨ì§€/ì»¬ëŸ¬ ë§¤í•‘
    function weatherIcon(cell) {
        if(cell.includes("ë§‘ìŒ")) return `<span class="sunny">â˜€ï¸ ë§‘ìŒ</span>`;
        if(cell.includes("íë¦¼")) return `<span class="cloud">â˜ï¸ íë¦¼</span>`;
        if(cell.includes("êµ¬ë¦„")) return `<span class="cloud">â›… êµ¬ë¦„ë§ìŒ</span>`;
        if(cell.includes("ë¹„") && !cell.includes("ì—†ìŒ")) return `<span class="rain">ğŸŒ§ï¸ ë¹„</span>`;
        if(cell.includes("ëˆˆ")) return `<span class="snow">â„ï¸ ëˆˆ</span>`;
        return `<span class="hazy">${cell}</span>`;
    }

    // ë‚ ì”¨ í‘œ ìë™ ë³€í™˜ í•¨ìˆ˜ (ë“±ê¸‰ ì»¬ëŸ¼ ìƒ‰ìƒ ê°•ì¡°)
    function renderWeatherTable(weather_message) {
        const lines = weather_message.trim().split('\n');
        if (lines.length < 2) return '<span>ë‚ ì”¨ ì •ë³´ ì—†ìŒ</span>';
        let table = '<table class="weather-table">';
        lines.forEach((line, i) => {
            const cells = line.split('\t');
            table += '<tr>';
            cells.forEach((cell, j) => {
                if(i === 0) {
                    table += `<th>${cell}</th>`;
                }
                // ì˜ˆë³´íƒ€ì…(ì‹¤í™©/ì´ˆë‹¨ê¸°ì˜ˆë³´)
                else if(j === 1) {
                    if(cell.includes('ì‹¤í™©')) table += `<td style="background:#e3fae5;color:#217943;font-weight:bold;">${cell}</td>`;
                    else if(cell.includes('ì´ˆë‹¨ê¸°')) table += `<td style="background:#e6f4ff;color:#2261ae;font-weight:bold;">${cell}</td>`;
                    else table += `<td>${cell}</td>`;
                }
                // ê¸°ì˜¨ë“±ê¸‰(j==3), í’ì†ë“±ê¸‰(j==6)
                else if(j === 3 || j === 6) {
                    table += `<td class="grade grade-${getGradeClass(cell)}">${cell}</td>`;
                }
                // í•˜ëŠ˜/ê°•ìˆ˜(ì´ëª¨ì§€)
                else if(j === 7) table += `<td>${weatherIcon(cell)}</td>`;
                else if(j === 8) table += `<td>${weatherIcon(cell)}</td>`;
                // ë‚˜ë¨¸ì§€
                else table += `<td>${cell}</td>`;
            });
            table += '</tr>';
        });
        table += '</table>';
        // í•˜ë‹¨ ì„¤ëª…
        table += `<div style="font-size:0.92em;margin:8px 0 0 3px;color:#888;">
            <span style="background:#e3fae5;padding:1px 7px;border-radius:6px;">ì´ˆë‹¨ê¸°ì‹¤í™©</span>
            : ê´€ì¸¡ê°’, í˜„ì¬ ì‹œê° ì´ì „ /
            <span style="background:#e6f4ff;padding:1px 7px;border-radius:6px;">ì´ˆë‹¨ê¸°ì˜ˆë³´</span>
            : 1ì‹œê°„ ê°„ê²© ì˜ˆì¸¡(6ì‹œê°„ ì´ë‚´, íŒŒë€ë°°ê²½)
        </div>`;
        return table;
    }

</script>
</body>
</html>
